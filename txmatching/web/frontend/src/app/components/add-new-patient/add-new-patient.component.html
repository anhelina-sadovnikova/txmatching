<div class="new-patient">
  <form [formGroup]="form" (ngSubmit)="handleSubmit()">

    <!-- Country -->
    <mat-form-field>
      <mat-label>Country</mat-label>

      <mat-chip-list #countryChip formControlName="country">
        <mat-chip *ngIf="form.controls.country.valid"
                  [removable]="true"
                  (removed)="handleRemove('country', countryInput)">
          <country [country]="selectedCountry"></country>
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <input formControlName="country"
               [matChipInputFor]="countryChip"
               [matAutocomplete]="donorAuto"
               [placeholder]="!selectedCountry ? 'Search by country code' : ''"
               #countryInput type="text">
      </mat-chip-list>

      <mat-autocomplete #donorAuto="matAutocomplete" (optionSelected)="handleSelect(countryInput)">
        <mat-option *ngFor="let c of filteredCountries | async" [value]="c">
          <country [country]="c"></country>
        </mat-option>
      </mat-autocomplete>

      <mat-error>
        <app-form-control-errors [control]="form.get('country')"></app-form-control-errors>
      </mat-error>

      <mat-hint>
        Search and select 1 country from {{allCountries.length}} available countries.
      </mat-hint>

    </mat-form-field>

    <!-- Donor -->
    <div>
      <h2>Donor</h2>

      <!-- Donor medical ID -->
      <mat-form-field>
        <mat-label>Medical ID</mat-label>
        <input [(ngModel)]="donor.medicalId" [ngModelOptions]="{standalone: true}" matInput type="text" required>
      </mat-form-field>

      <!-- Donor Type -->
      <div>
        <mat-label>Donor type</mat-label>
        <mat-button-toggle-group [(ngModel)]="donor.type" [ngModelOptions]="{standalone: true}">
          <mat-button-toggle *ngFor="let type of allDonorTypes"
                             [value]="type">
            {{ type | donorTypeLabel }}
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Donor Blood Group -->
      <div>
        <mat-label>Donor blood group</mat-label>
        <mat-button-toggle-group [(ngModel)]="donor.bloodGroup" [ngModelOptions]="{standalone: true}">
          <mat-button-toggle *ngFor="let bg of allBloodGroups"
                             [value]="bg">
            {{ bg }}
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Donor antigens -->
      <h4>
        Antigens
        <app-count [count]="donor.antigens.length"></app-count>
      </h4>
      <mat-form-field>
        <mat-label>Donor's antigens</mat-label>
        <mat-chip-list #antigensChipList>
          <mat-chip *ngFor="let code of donor.antigens"
                    (removed)="donor.removeAntigen(code)"
                    [title]="'Raw code: ' + code"
                    [removable]="true">
            {{code}}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <input #donorAntigensInput
                 [matChipInputFor]="antigensChipList"
                 [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                 (matChipInputTokenEnd)="addAntigen(donor, $event.value, donorAntigensInput)"
                 matInput
                 type="text">
        </mat-chip-list>
        <mat-hint>
          Add new antigens by typing codes followed by
          <span class="key">Space <mat-icon>space_bar</mat-icon></span>
          or
          <span class="key">Enter <mat-icon>keyboard_return</mat-icon></span>
        </mat-hint>
      </mat-form-field>
    </div>

    <!-- Donor Sex -->
    <div>
      <mat-label>Donor sex</mat-label>
      <mat-button-toggle-group [(ngModel)]="donor.sex" [ngModelOptions]="{standalone: true}">
        <mat-button-toggle *ngFor="let sex of allSexes"
                           [value]="sex">
          {{ sex }}
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>

    <!-- Donor height -->
    <mat-form-field>
      <mat-label>Height [cm]</mat-label>
      <input [(ngModel)]="donor.height" [ngModelOptions]="{standalone: true}" matInput type="number">
    </mat-form-field>

    <!-- Donor weight -->
    <mat-form-field>
      <mat-label>Weight [kg]</mat-label>
      <input [(ngModel)]="donor.weight" [ngModelOptions]="{standalone: true}" matInput type="number">
    </mat-form-field>

    <!-- Donor year of birth -->
    <mat-form-field>
      <mat-label>Year of birth</mat-label>
      <input [(ngModel)]="donor.yearOfBirth" [ngModelOptions]="{standalone: true}" matInput type="number">
    </mat-form-field>

    <app-button type="submit" variant="success"
                [loading]="loading"
                [disabled]="loading"
                [success]="!loading && success">Save changes
    </app-button>
  </form>
</div>
