{% from 'patient_macro.html' import render_patient %}
{% from 'render_score_macro.html' import render_score %}

{% macro render_transplant(donor, recipient, score_dict, matching_index, round_index, pair_index) %}
{% set score = score_dict[(donor.db_id, recipient.db_id)] %}
{% set matching_blood_group = donor.parameters.blood_group if donor.parameters.blood_group in recipient.parameters.acceptable_blood_groups else None %}
{% set matching_antigens = donor.parameters.hla_antigens.codes | intersect(recipient.parameters.hla_antigens.codes) %}
{% set scoreA = (matching_antigens | filtered_count_by_prefix("A")) * 1 %}
{% set scoreB = (matching_antigens | filtered_count_by_prefix("B")) * 3 %}
{% set scoreDR = (matching_antigens | filtered_count_by_prefix("DR")) * 9 %}

<td>
    {{ render_patient(donor, matching_blood_group, matching_antigens) }}
</td>
<td class="patient_box">
        <h1>Score: {{ score }}</h1>
        <hr>
        <b>Blood:</b>
        {% for group in matching_blood_group %}
            <span class="inline_code matching-blood-group">{{ group }}</span>
        {% endfor %}
        <hr>
        {{render_score("A", matching_antigens, scoreA)}}
        <hr>
        {{render_score("B", matching_antigens, scoreB)}}
        <hr>
        {{render_score("DR", matching_antigens, scoreDR)}}
        <hr>
        {{scoreA}} + {{scoreB}} + {{scoreDR}} = {{score}}
</td>
<td>
    {{ render_patient(recipient, matching_blood_group, matching_antigens) }}
</td>
{% endmacro %}

