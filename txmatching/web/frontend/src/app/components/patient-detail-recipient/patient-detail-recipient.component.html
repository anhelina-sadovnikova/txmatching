<div *ngIf="item" class="detail-recipient">

  <patient [patient]="item"></patient>

  <form [formGroup]="form">

    <!-- todo: change in item -->
    <!-- Checkboxes -->
    <h4>Conditions for new donor</h4>
    <div class="checkboxes">
      <mat-slide-toggle *ngIf="item.recipient_requirements.require_compatible_blood_group !== undefined"
                        formControlName="require_compatible_blood_group"
                        (change)="enableSave = true"
                        [checked]="item.recipient_requirements.require_compatible_blood_group">
        Require compatible blood group
      </mat-slide-toggle>
      <mat-slide-toggle *ngIf="item.recipient_requirements.require_better_match_in_compatibility_index !== undefined"
                        formControlName="require_better_match_in_compatibility_index"
                        (change)="enableSave = true"
                        [checked]="item.recipient_requirements.require_better_match_in_compatibility_index">
        Require new donor having better CI match than original donor
      </mat-slide-toggle>
      <mat-slide-toggle *ngIf="item.recipient_requirements.require_better_match_in_compatibility_index_or_blood_group !== undefined"
                        formControlName="require_better_match_in_compatibility_index_or_blood_group"
                        (change)="enableSave = true"
                        [checked]="item.recipient_requirements.require_better_match_in_compatibility_index_or_blood_group">
        Require new donor having better CI match than original donor or blood group match
      </mat-slide-toggle>
    </div>

    <!-- Antigens -->
    <h4>
      Antigens
      <app-count [count]="selectedAntigens.length"></app-count>
    </h4>
    <mat-form-field>
      <mat-label>Recipient's antigens</mat-label>
      <mat-chip-list #antigensChipList>
        <mat-chip *ngFor="let code of selectedAntigens"
                  (removed)="removeAntigen(code)"
                  [removable]="true">
          {{code}}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <input #antigensInput
               formControlName="antigens"
               [matAutocomplete]="auto"
               [matChipInputFor]="antigensChipList"
               [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
               (matChipInputTokenEnd)="addAntigen($event.value, antigensInput)"
               matInput
               placeholder="Search by antigen code"
               type="text">
      </mat-chip-list>
      <mat-autocomplete #auto="matAutocomplete" (optionSelected)="addAntigen($event.option.value, antigensInput)">
        <mat-option *ngFor="let code of filteredAntigensCodes | async" [value]="code">
          {{code}}
        </mat-option>
      </mat-autocomplete>
      <mat-hint>
        Search and select multiple antigens from {{availableAntigensCodes.length}} available antigens.
      </mat-hint>
    </mat-form-field>
  </form>

  <form [formGroup]="antibodiesForm">
    <!-- Antibodies -->
    <div class="antibodies">
      <h4>
        Antibodies
        <app-count [count]="selectedAntibodies.length"></app-count>
      </h4>
      <div class="antibodies__list">
        <div class="placeholder" *ngIf="selectedAntibodies.length === 0">
          Recipient has no antibodies yet.
        </div>
        <mat-chip-list *ngIf="selectedAntibodies.length > 0">
          <mat-chip *ngFor="let a of selectedAntibodies"
                    (removed)="removeAntibody(a)">

            <div class="antibody-chip">
              {{a.code}}
              <div class="mfi">MFI: <strong>{{a.mfi}}</strong></div>
            </div>

            <mat-icon class="cancel" matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-list>
      </div>

      <div class="antibodies__add">
        <mat-form-field>
          <mat-label>Antibody code</mat-label>
          <mat-chip-list #antibodyChip>
            <mat-chip *ngIf="antibodyValue"
                      [removable]="true"
                      (removed)="handleNewAntibodyRemove(antibody)">
              {{antibodyValue}}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
            <input #antibody
                   matInput
                   formControlName="antibody"
                   [matAutocomplete]="antibodyAuto"
                   [matChipInputFor]="antibodyChip"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   (matChipInputTokenEnd)="handleNewAntibodyInputEnd($event.value, antibody)"
                   [placeholder]="!antibodyValue ? 'Search by antibody code or add new' : ''"
                   type="text">
          </mat-chip-list>
          <mat-autocomplete #antibodyAuto="matAutocomplete"
                            (optionSelected)="handleNewAntibodySelect($event.option.value, antibody)"
                            [displayWith]="displayFn">
            <mat-option *ngFor="let a of filteredAntibodies | async" [value]="a">
              {{a.code}}
            </mat-option>
          </mat-autocomplete>
          <mat-hint>
            Search and select multiple antibodies from {{availableAntibodies.length}} antibodies.
          </mat-hint>
        </mat-form-field>
      </div>
    </div>
  </form>

  <app-button [loading]="loading"
              [disabled]="!enableSave || loading"
              [variant]="'success'">Save changes
  </app-button>

</div>
